"use strict";var serviceBase="http://manducoauth.azurewebsites.net/",app=angular.module("angularCordovaApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","LocalStorageModule","angular-loading-bar"]);app.config(["$routeProvider",function(a){a.when("/home",{controller:"homeController",templateUrl:"views/home.html"}),a.when("/login",{controller:"loginController",templateUrl:"views/login.html"}),a.when("/signup",{controller:"signupController",templateUrl:"views/signup.html"}),a.when("/orders",{controller:"ordersController",templateUrl:"views/orders.html"}),a.when("/refresh",{controller:"refreshController",templateUrl:"views/refresh.html"}),a.when("/tokens",{controller:"tokensManagerController",templateUrl:"views/tokens.html"}),a.when("/associate",{controller:"associateController",templateUrl:"views/associate.html"}),a.otherwise({redirectTo:"/home"})}]).constant("ngAuthSettings",{apiServiceBaseUri:serviceBase,clientId:"consoleApp"}).config(["$httpProvider",function(a){a.interceptors.push("authInterceptorService")}]).run(["authService",function(a){a.fillAuthData()}]),app.factory("authInterceptorService",["$q","$injector","$location","localStorageService",function(a,b,c,d){var e={},f=function(a){a.headers=a.headers||{};var b=d.get("authorizationData");return b&&(a.headers.Authorization="Bearer "+b.token),a},g=function(e){if(401===e.status){var f=b.get("authService"),g=d.get("authorizationData");if(g&&g.useRefreshTokens)return c.path("/refresh"),a.reject(e);f.logOut(),c.path("/login")}return a.reject(e)};return e.request=f,e.responseError=g,e}]),app.factory("authService",["$http","$q","localStorageService","ngAuthSettings",function(a,b,c,d){var e=d.apiServiceBaseUri,f={},g={isAuth:!1,userName:"",useRefreshTokens:!1},h={provider:"",userName:"",externalAccessToken:""},i=function(b){return k(),a.post(e+"api/account/register",b).then(function(a){return a})},j=function(f){var h="grant_type=password&username="+f.userName+"&password="+f.password;f.useRefreshTokens&&(h=h+"&client_id="+d.clientId);var i=b.defer();return a.post(e+"token",h,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){f.useRefreshTokens?c.set("authorizationData",{token:a.access_token,userName:f.userName,refreshToken:a.refresh_token,useRefreshTokens:!0}):c.set("authorizationData",{token:a.access_token,userName:f.userName,refreshToken:"",useRefreshTokens:!1}),g.isAuth=!0,g.userName=f.userName,g.useRefreshTokens=f.useRefreshTokens,i.resolve(a)}).error(function(a,b){k(),i.reject(a)}),i.promise},k=function(){c.remove("authorizationData"),g.isAuth=!1,g.userName="",g.useRefreshTokens=!1},l=function(){var a=c.get("authorizationData");a&&(g.isAuth=!0,g.userName=a.userName,g.useRefreshTokens=a.useRefreshTokens)},m=function(){var f=b.defer(),g=c.get("authorizationData");if(g&&g.useRefreshTokens){var h="grant_type=refresh_token&refresh_token="+g.refreshToken+"&client_id="+d.clientId;c.remove("authorizationData"),a.post(e+"token",h,{headers:{"Content-Type":"application/x-www-form-urlencoded"}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:a.refresh_token,useRefreshTokens:!0}),f.resolve(a)}).error(function(a,b){k(),f.reject(a)})}return f.promise},n=function(d){var f=b.defer();return a.get(e+"api/account/ObtainLocalAccessToken",{params:{provider:d.provider,externalAccessToken:d.externalAccessToken}}).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),g.isAuth=!0,g.userName=a.userName,g.useRefreshTokens=!1,f.resolve(a)}).error(function(a,b){k(),f.reject(a)}),f.promise},o=function(d){var f=b.defer();return a.post(e+"api/account/registerexternal",d).success(function(a){c.set("authorizationData",{token:a.access_token,userName:a.userName,refreshToken:"",useRefreshTokens:!1}),g.isAuth=!0,g.userName=a.userName,g.useRefreshTokens=!1,f.resolve(a)}).error(function(a,b){k(),f.reject(a)}),f.promise};return f.saveRegistration=i,f.login=j,f.logOut=k,f.fillAuthData=l,f.authentication=g,f.refreshToken=m,f.obtainAccessToken=n,f.externalAuthData=h,f.registerExternal=o,f}]),app.factory("ordersService",["$http","ngAuthSettings",function(a,b){var c=b.apiServiceBaseUri,d={},e=function(){return a.get(c+"api/orders").then(function(a){return a})};return d.getOrders=e,d}]),app.factory("tokensManagerService",["$http","ngAuthSettings",function(a,b){var c=b.apiServiceBaseUri,d={},e=function(){return a.get(c+"api/refreshtokens").then(function(a){return a})},f=function(b){return a["delete"](c+"api/refreshtokens/?tokenid="+b).then(function(a){return a})};return d.deleteRefreshTokens=f,d.getRefreshTokens=e,d}]),app.controller("indexController",["$scope","$location","authService",function(a,b,c){a.logOut=function(){c.logOut(),b.path("/home")},a.authentication=c.authentication}]),app.controller("homeController",["$scope",function(a){}]),app.controller("loginController",["$scope","$location","authService","ngAuthSettings",function(a,b,c,d){a.loginData={userName:"",password:"",useRefreshTokens:!1},a.message="",a.login=function(){c.login(a.loginData).then(function(a){b.path("/orders")},function(b){a.message=b.error_description})},a.authExternalProvider=function(b){var c=location.protocol+"//"+location.host+"/authcomplete.html",e=d.apiServiceBaseUri+"api/Account/ExternalLogin?provider="+b+"&response_type=token&client_id="+d.clientId+"&redirect_uri="+c;window.$windowScope=a;window.open(e,"Authenticate Account","location=0,status=0,width=600,height=750")},a.authCompletedCB=function(d){a.$apply(function(){if("False"==d.haslocalaccount)c.logOut(),c.externalAuthData={provider:d.provider,userName:d.external_user_name,externalAccessToken:d.external_access_token},b.path("/associate");else{var e={provider:d.provider,externalAccessToken:d.external_access_token};c.obtainAccessToken(e).then(function(a){b.path("/orders")},function(b){a.message=b.error_description})}})}}]),app.controller("signupController",["$scope","$location","$timeout","authService",function(a,b,c,d){a.savedSuccessfully=!1,a.message="",a.registration={userName:"",password:"",confirmPassword:""},a.signUp=function(){d.saveRegistration(a.registration).then(function(b){a.savedSuccessfully=!0,a.message="User has been registered successfully, you will be redicted to login page in 2 seconds.",e()},function(b){var c=[];for(var d in b.data.modelState)for(var e=0;e<b.data.modelState[d].length;e++)c.push(b.data.modelState[d][e]);a.message="Failed to register user due to:"+c.join(" ")})};var e=function(){var a=c(function(){c.cancel(a),b.path("/login")},2e3)}}]),app.controller("ordersController",["$scope","ordersService",function(a,b){a.orders=[],b.getOrders().then(function(b){a.orders=b.data},function(a){})}]),app.controller("refreshController",["$scope","$location","authService",function(a,b,c){a.authentication=c.authentication,a.tokenRefreshed=!1,a.tokenResponse=null,a.refreshToken=function(){c.refreshToken().then(function(b){a.tokenRefreshed=!0,a.tokenResponse=b},function(a){b.path("/login")})}}]),app.controller("tokensManagerController",["$scope","tokensManagerService",function(a,b){a.refreshTokens=[],b.getRefreshTokens().then(function(b){a.refreshTokens=b.data},function(a){alert(a.data.message)}),a.deleteRefreshTokens=function(c,d){d=window.encodeURIComponent(d),b.deleteRefreshTokens(d).then(function(b){a.refreshTokens.splice(c,1)},function(a){alert(a.data.message)})}}]),app.controller("associateController",["$scope","$location","$timeout","authService",function(a,b,c,d){a.savedSuccessfully=!1,a.message="",a.registerData={userName:d.externalAuthData.userName,provider:d.externalAuthData.provider,externalAccessToken:d.externalAuthData.externalAccessToken},a.registerExternal=function(){d.registerExternal(a.registerData).then(function(b){a.savedSuccessfully=!0,a.message="User has been registered successfully, you will be redicted to orders page in 2 seconds.",e()},function(b){var c=[];for(var d in b.modelState)c.push(b.modelState[d]);a.message="Failed to register user due to:"+c.join(" ")})};var e=function(){var a=c(function(){c.cancel(a),b.path("/orders")},2e3)}}]),angular.module("manducoApp").run(["$templateCache",function(a){a.put("views/about.html","<p>This is the about view.</p>"),a.put("views/associate.html",'<div class="row"> <div class="col-md-2"> &nbsp; </div> <div class="col-md-8"> <h3>Associate your {{registerData.provider}} Account</h3> <hr> <p class="text-success">You have successfully autheticated with <strong>{{registerData.provider}} </strong>. Please enter a user name below for this site and click the Register button to log in.</p> <div class="row"> <div class="col-md-3"> &nbsp; </div> <div class="col-md-6"> <div class="form-group"> <input type="text" class="form-control" placeholder="Username" data-ng-model="registerData.userName" required autofocus> <button class="btn btn-sm btn-info btn-block" type="button" style="margin-top:10px" data-ng-click="registerExternal()">Register</button> </div> <div data-ng-hide="message == \'\'" data-ng-class="(savedSuccessfully) ? \'alert alert-success\' : \'alert alert-danger\'"> {{message}} </div> </div> <div class="col-md-3"> &nbsp; </div> </div> </div> <div class="col-md-2"> &nbsp; </div> </div>'),a.put("views/home.html",'<div class="row"> <div class="col-md-2"> &nbsp; </div> <div class="col-md-4"> <h2>Login</h2> <p class="text-primary">If you have Username and Password, you can use the button below to access the secured content using a token.</p> <p><a class="btn btn-info" href="#/login" role="button">Login &raquo;</a></p> </div> <div class="col-md-4"> <h2>Sign Up</h2> <p class="text-primary">Use the button below to create Username and Password to access the secured content using a token.</p> <p><a class="btn btn-info" href="#/signup" role="button">Sign Up &raquo;</a></p> </div> <div class="col-md-2"> &nbsp; </div> </div>'),a.put("views/login.html",'<form role="form"> <div class="row"> <div class="col-md-2"> &nbsp; </div> <div class="col-md-4"> <h2 class="form-login-heading">Login</h2> <input type="text" class="form-control" placeholder="Username" data-ng-model="loginData.userName" required autofocus> <input type="password" class="form-control" placeholder="Password" data-ng-model="loginData.password" required> <div class="checkbox"> <label> <input type="checkbox" data-ng-model="loginData.useRefreshTokens"><strong> Use Refresh Tokens</strong> </label> </div> <button class="btn btn-md btn-info btn-block" type="submit" data-ng-click="login()">Login</button> <div data-ng-hide="message == \'\'" class="alert alert-danger"> {{message}} </div> </div> <div class="col-md-4"> <h2 class="form-login-heading">Social Logins</h2> <p>Or you can login using one of the social logins bleow</p> <button class="btn btn-large btn-facebook btn-block" type="button" data-ng-click="authExternalProvider(\'Facebook\')"><i class="fa fa-facebook"></i> | Connect with Facebook</button> <button class="btn btn-large btn-google-plus btn-block" type="button" data-ng-click="authExternalProvider(\'Google\')"><i class="fa fa-google-plus"></i> | Connect with Google+</button> </div> <div class="col-md-2"> &nbsp; </div> </div> </form>'),a.put("views/main.html",'<div class="jumbotron"> <h1>\'Allo, \'Allo!</h1> <p class="lead"> <img src="images/yeoman.c582c4d1.png" alt="I\'m Yeoman"><br> Always a pleasure scaffolding your apps. </p> <p><a class="btn btn-lg btn-success" ng-href="#/">Splendid!<span class="glyphicon glyphicon-ok"></span></a></p> </div> <div class="row marketing"> <h4>HTML5 Boilerplate</h4> <p> HTML5 Boilerplate is a professional front-end template for building fast, robust, and adaptable web apps or sites. </p> <h4>Angular</h4> <p> AngularJS is a toolset for building the framework most suited to your application development. </p> <h4>Karma</h4> <p>Spectacular Test Runner for JavaScript.</p> </div>'),a.put("views/orders.html",'<div class="row"> <div class="col-md-2"> &nbsp; </div> <div class="col-md-8"> <table class="table table-striped table-bordered table-hover"> <thead> <tr> <th>Order ID</th> <th>Customer</th> <th>City</th> <th>Shipped</th> </tr> </thead> <tbody> <tr data-ng-repeat="order in orders"> <td> {{ order.orderID }} </td> <td> {{ order.customerName }} </td> <td> {{ order.shipperCity }} </td> <td> <input type="checkbox" data-ng-model="order.isShipped" disabled> </td> </tr> </tbody> </table> </div> <div class="col-md-2"> &nbsp; </div> </div>'),a.put("views/refresh.html",'<div class="row"> <div class="col-md-3"> &nbsp; </div> <div class="col-md-6"> <p data-ng-hide="authentication.useRefreshTokens">User <strong>{{authentication.userName}}</strong> has disabled <strong>Refresh Tokens</strong> once logged in, you can not refresh tokens.</p> <div data-ng-show="authentication.useRefreshTokens"> <p class="text-success">Use this view to obtain new access token using the refresh token.</p> <p>User <strong>{{authentication.userName}}</strong> has enabled <strong>Refresh Tokens</strong> once logged in, to refresh your current access token click on the button below.</p> <button class="btn btn-lg btn-info btn-block" type="submit" data-ng-click="refreshToken()" data-ng-disabled="!authentication.userName && !authentication.useRefreshTokens">Refresh Token</button> </div> <div data-ng-show="authentication.useRefreshTokens" style="margin-top:10px"> <div class="panel panel-success" data-ng-show="tokenRefreshed"> <div class="panel-heading"> <h3 class="panel-title">Successfully refreshed Access Token</h3> </div> <div class="panel-body"> <p>Access_token: {{tokenResponse.access_token | limitTo : 30}}....</p> <p><a href="#/orders">Click here to view orders using the new Access Token</a></p> </div> </div> </div> </div> <div class="col-md-3"> &nbsp; </div> </div>'),a.put("views/signup.html",'<form class="form-login" role="form"> <h2 class="form-login-heading">Sign up</h2> <input type="text" class="form-control" placeholder="Username" data-ng-model="registration.userName" required autofocus> <input type="password" class="form-control" placeholder="Password" data-ng-model="registration.password" required> <input type="password" class="form-control" placeholder="Confirm Password" data-ng-model="registration.confirmPassword" required> <button class="btn btn-lg btn-info btn-block" type="submit" data-ng-click="signUp()">Submit</button> <div data-ng-hide="message == \'\'" data-ng-class="(savedSuccessfully) ? \'alert alert-success\' : \'alert alert-danger\'"> {{message}} </div> </form>'),a.put("views/tokens.html",'<div class="row"> <div class="col-md-2"> &nbsp; </div> <div class="col-md-8"> <h3>List of Refresh Tokens ({{refreshTokens.length}})</h3> <table class="table table-striped table-bordered table-hover"> <thead> <tr> <th>Action</th> <th>Subject</th> <th>Client</th> <th>Issued At (UTC)</th> <th>Expires At (UTC)</th> </tr> </thead> <tbody> <tr data-ng-repeat="token in refreshTokens"> <td> <a data-ng-click="deleteRefreshTokens($index,token.id)" href="">Remove</a> </td> <td> {{ token.subject }} </td> <td> {{ token.clientId }} </td> <td> {{ token.issuedUtc | date:\'medium\' }} </td> <td> {{ token.expiresUtc | date:\'medium\' }} </td> </tr> </tbody> </table> </div> <div class="col-md-2"> &nbsp; </div> </div>'),a.put("views/usuario.html","<p>{{usuario}}</p>")}]);